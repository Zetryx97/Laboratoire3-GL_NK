<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/site-nouvelles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" rel="stylesheet"> <!--// lien pour avoir accès au icon-->
    <title>Laboratoire 3</title>
</head>
<body>
    
    <header class="entête">
            <div class="titre-page">Gestionnaire de nouvelles</div>

            <div id="add-news-icon" class="icon fa-regular fa-square-plus" title="Ajouter une nouvelle"></div>
    </header>

    <div id="nouvelleDialog">
        <form id="nouvelleForm">
            <input type="hidden" id="id_nouvelle" value="0">
            <hr>
            <input type="text" class="input-form" id="category_nouvelle" placeholder="Catégorie..." required>
            <hr>
            <input type="text" class="input-form" id="titre_nouvelle" placeholder="Titre..." required>
            <hr>
            <input type="text" class="input-form" id="texte_nouvelle" placeholder="Texte..." required>
            <hr>
            <input type="text" class="input-form" id="imageUrl_nouvelle" placeholder="Url de l'image..." required>
            <hr>
            <input type="text" class="input-form" id="date_nouvelle" placeholder="Date..." required>
            <hr>
        </form>
    </div>

    <div class="wrapper-news" id="news-list">

    </div>



    <script src="scripts/api-server.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script defer>

        let currentEtag = "";


        HEAD(checkETag);


        function error(status) {
        }


        //Dialoge pour ajouter une nouvelle

        function AddNewsSuccess()
        {
            alert("Cette nouvelle a été correctement ajouter!");
        }
        $("#nouvelleDialog").dialog(
        {
            title: "Nouvelle chronique",
            autoOpen: false,
            show: { effect: 'fade', speed: 250 },
            hide: { effect: 'fade', speed: 250 },
        });

        $("#nouvelleDialog").dialog("option", "buttons",
        [
            {
                id: "nouvelleDialogAcceptBtn",
                text: "Ajouter...",
                click: function(){
                    //Caller fonction pour ajouter nouvelles
                    AddNewsSuccess();
                    $(this).dialog('close');
                }

            },

            {
                id: "nouvelleDialogCancelBtn",
                text: "Annuler...",
                click: function(){
                    $(this).dialog('close');
                }

            }
        ]);

        $("#add-news-icon").click((e) =>{
            $("#nouvelleDialog").dialog('open');
        });


        //Show All news
        function insertIntoNewsList(nouvelle)
        {
            let imageUrlElement = $(`<img class="image-dimension" src=${nouvelle.ImageUrl}>`);
            let categoryElement = $(`<div>${nouvelle.Category}</div>`);
            let titleElement = $(`<div>${nouvelle.Title}</div>`);
            let textElement = $(`<div>${nouvelle.Text}</div>`);
            let dateElement = $(`<div>${nouvelle.Date}</div>`);

            let nouvelleRow = $(`<div class="box-news"></div>`);

            
            nouvelleRow.append(imageUrlElement);
            nouvelleRow.append(categoryElement);
            nouvelleRow.append("<hr>");
            nouvelleRow.append(titleElement);
            nouvelleRow.append(textElement);
            nouvelleRow.append("<br/>")
            nouvelleRow.append(dateElement);

            $("#news-list").append(nouvelleRow);
        }

        function ShowNewsList(nouvelles, ETag)
        {
            currentEtag = ETag;
            $("#news-list").empty();
            for(let nouvelle of nouvelles)
            {
                insertIntoNewsList(nouvelle);
            }
        }

        function getNewsList()
        {
            let queryString = "?sort=Date,desc";
            GET_ALL(ShowNewsList,error,queryString);
        }



        function checkETag(ETag)
        {
            if(ETag != currentEtag)
            {
                currentEtag = ETag;
                getNewsList();
            }
        }

        //Create nouvelle

        function GetNewsFromForm()
        {
            let nouvelle = {Id: parseInt($("#id_nouvelle").val())};

            return nouvelle;
        }
    </script>
</body>
</html>